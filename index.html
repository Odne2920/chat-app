
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperRush Chat</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
        body{height:100vh;background:#0f0f14;color:#fff;display:flex;justify-content:center;align-items:center}
        #app{width:100%;max-width:400px;height:90vh;background:#18181f;display:flex;flex-direction:column;border-radius:20px;overflow:hidden;border:1px solid #333}
        .screen{flex:1;display:none;flex-direction:column;padding:20px}
        .active{display:flex !important}
        input{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #333;background:#0f0f14;color:#fff;outline:none}
        button{width:100%;padding:12px;border-radius:8px;border:none;background:#7dd3fc;color:#0f0f14;font-weight:bold;cursor:pointer}
        #messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
        .msg{padding:8px 12px;border-radius:12px;background:#222;max-width:80%}
        .me{align-self:flex-end;background:#2563eb}
        .author{font-size:10px;color:#7dd3fc;display:block}
    </style>
</head>
<body>

<div id="app">
    <div id="loginScreen" class="screen active">
        <h2>HyperRush</h2>
        <input id="email" type="email" placeholder="E-mail" />
        <input id="pass" type="password" placeholder="Wachtwoord (min. 6 tekens)" />
        <button id="loginBtn">Log in</button>
        <button id="regBtn" style="background:none; color:#7dd3fc; margin-top:10px">Maak account</button>
        <p id="status" style="color:orange; font-size:12px; margin-top:10px; text-align:center"></p>
    </div>

    <div id="usernameScreen" class="screen">
        <h2>Kies een naam</h2>
        <input id="nick" placeholder="Jouw bijnaam..." />
        <button id="saveNick">Start</button>
    </div>

    <div id="chatScreen" class="screen">
        <div id="messages"></div>
        <div style="display:flex; gap:5px; padding-top:10px">
            <input id="msgInput" placeholder="Typ..." style="margin:0" />
            <button id="sendBtn" style="width:auto">></button>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://fahbqdajxnhswevdagdn.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhaGJxZGFqeG5oc3dldmRhZ2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTEyODEsImV4cCI6MjA4NjEyNzI4MX0.UPgPxyaWBULjH4jL8UaSr6bJXTsFWWJRIYodHmXeVTI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null;

    function show(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function load() {
        const { data: { session } } = await supabase.auth.getSession();
        user = session?.user;
        if (!user) return show('loginScreen');

        let { data: prof } = await supabase.from('users').select('*').eq('id', user.id).maybeSingle();
        if (!prof) {
            const { data: nProf } = await supabase.from('users').insert([{id: user.id, email: user.email}]).select().single();
            prof = nProf;
        }

        if (!prof.username) show('usernameScreen');
        else {
            show('chatScreen');
            fetchMsgs();
            supabase.channel('room1').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, () => fetchMsgs()).subscribe();
        }
    }

    async function fetchMsgs() {
        const { data } = await supabase.from('messages').select('*, users(username)').order('created_at', {ascending:true});
        const box = document.getElementById('messages');
        box.innerHTML = data.map(m => `
            <div class="msg ${m.user_id === user.id ? 'me' : ''}">
                <span class="author">${m.users?.username || 'Anoniem'}</span>
                ${m.content}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    }

    document.getElementById('regBtn').onclick = async () => {
        const { error } = await supabase.auth.signUp({ email: email.value, password: pass.value });
        document.getElementById('status').textContent = error ? error.message : "Geregistreerd! Log nu in.";
    };

    document.getElementById('loginBtn').onclick = async () => {
        const { error } = await supabase.auth.signInWithPassword({ email: email.value, password: pass.value });
        if (error) document.getElementById('status').textContent = error.message;
        else load();
    };

    document.getElementById('saveNick').onclick = async () => {
        await supabase.from('users').update({ username: nick.value }).eq('id', user.id);
        load();
    };

    document.getElementById('sendBtn').onclick = async () => {
        const content = msgInput.value;
        msgInput.value = '';
        await supabase.from('messages').insert([{ content, user_id: user.id }]);
    };

    load();
</script>
</body>
</html>
